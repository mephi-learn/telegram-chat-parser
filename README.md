# Парсер чатов Telegram

Этот проект представляет собой клиент-серверное приложение для парсинга экспортированных чатов Telegram и обогащения данных об участниках через Telegram API.

Ключевая особенность системы — **пул из нескольких Telegram-клиентов**, управляемый роутером, который распределяет нагрузку, выполняет проверки работоспособности и обеспечивает отказоустойчивость при взаимодействии с API.

## Содержание
- [Возможности](#возможности)
- [Архитектура](#архитектура)
- [Требования](#требования)
- [Конфигурация](#конфигурация)
  - [Приоритет источников](#приоритет-источников)
  - [Параметры конфигурации](#параметры-конфигурации)
- [Сборка](#сборка)
- [Запуск](#запуск)
  - [Сервер](#сервер)
  - [Клиент](#клиент)
- [Документация по API](#документация-по-api)
- [Разработка](#разработка)

## Возможности

*   Парсинг файлов экспорта чатов Telegram (JSON).
*   Извлечение участников (авторов и упоминаний).
*   **Поддержка нескольких Telegram-аккаунтов** для распределения нагрузки и повышения надежности.
*   **Роутер клиентов** с автоматическими проверками работоспособности (health-check) и временным исключением неработающих аккаунтов.
*   Обогащение данных об участниках (имя, username, био) через пул воркеров, работающих с Telegram API.
*   Клиент-серверная архитектура с асинхронной обработкой задач.
*   Кэширование результатов по SHA256-хешу содержимого файла.
*   Получение результата по `task_id` или по хешу файла (через кеш).
*   Пагинация для больших наборов результатов.
*   Корректное завершение работы (graceful shutdown).
*   Эндпоинт для проверки состояния (`/health`).

## Архитектура

Приложение состоит из двух основных компонентов:

*   **Сервер:** Принимает файлы чатов по HTTP API, ставит их в очередь на обработку, взаимодействует с Telegram API и отдает результаты.
*   **Клиент:** CLI-инструмент для отправки файлов на сервер и получения результатов.

Центральным компонентом серверной части является **Роутер Telegram-клиентов** (`telegram.Router`). Он инициализирует и управляет пулом клиентов на основе конфигурации (`telegram_api.servers`). При поступлении запроса на обогащение данных роутер выбирает работоспособного клиента по стратегии Round Robin. Встроенный механизм health-check периодически проверяет доступность каждого клиента и временно исключает из ротации те, которые не отвечают.

Обработка файлов происходит асинхронно. После получения файла сервер немедленно возвращает `task_id`, а обработка (парсинг, извлечение и обогащение) выполняется в фоновой горутине.

## Требования

*   Go 1.21+
*   Один или несколько аккаунтов Telegram с учетными данными (API ID, API Hash, номер телефона).

## Конфигурация

Конфигурация приложения загружается из файла `config.yml`.

### Приоритет источников

Параметры загружаются из файла `config.yml`. Значения могут быть переопределены переменными окружения (например, при запуске в Docker).

### Параметры конфигурации

| YAML-путь | Переменная окружения | Описание | По умолчанию |
| :--- | :--- | :--- | :--- |
| `server.host` | `SERVER_HOST` | Хост, на котором запускается сервер. | `"0.0.0.0"` |
| `server.port` | `SERVER_PORT` | Порт сервера. | `8080` |
| `server.shutdown_timeout` | `SHUTDOWN_TIMEOUT` | Таймаут на корректное завершение работы сервера. | `15s` |
| `telegram_api.servers` | - | **(Обязательно)** Список конфигураций для каждого Telegram-аккаунта. | - |
| `telegram_api.servers[].api_id` | `API_ID` | **(Обязательно)** API ID аккаунта. | - |
| `telegram_api.servers[].api_hash`| `API_HASH` | **(Обязательно)** API Hash аккаунта. | - |
| `telegram_api.servers[].phone_number` | `PHONE_NUMBER` | **(Обязательно)** Номер телефона аккаунта. | - |
| `telegram_api.servers[].session_file` | `SESSION_FILE` | Файл для хранения сессии Telegram. | `"tg.session"` |
| `telegram_api.health_check_interval` | `HEALTH_CHECK_INTERVAL` | Интервал проверки работоспособности Telegram-клиентов. | `30s` |
| `processing.task_timeout`| `TASK_TIMEOUT` | Таймаут на обработку одной задачи (0 - без таймаута). | `30s` |
| `processing.cache_ttl` | `CACHE_TTL` | Время жизни (TTL) для задачи и ее кэшированного результата. | `60m` |
| `enrichment.pool_size` | `ENRICHMENT_POOL_SIZE` | Количество воркеров для одновременного обогащения данных. | `1` |
| `enrichment.client_retry_pause` | `CLIENT_RETRY_PAUSE`| Пауза перед повторной попыткой получить клиента из роутера, если все заняты. | `1s` |
| `logging.level` | `LOGGING_LEVEL` | Уровень логирования (`debug`, `info`, `warn`, `error`). | `"info"` |

**Пример конфигурации `telegram_api.servers`:**
```yaml
telegram_api:
  health_check_interval_seconds: 30
  servers:
    - api_id: 12345678
      api_hash: "hash_one"
      phone_number: "+11111111111"
      session_file: "tg1.session"
    - api_id: 87654321
      api_hash: "hash_two"
      phone_number: "+22222222222"
      session_file: "tg2.session"
```

> **Устаревшие параметры:** Секция `rate_limiter` была полностью удалена. Вместо нее используется секция `enrichment`.

## Сборка

```bash
# Сборка сервера
go build -o bin/server cmd/server/main.go

# Сборка клиента
go build -o bin/client cmd/client/main.go
```

## Запуск

### Бот

Telegram-бот запускается как отдельное приложение и предоставляет интерфейс для взаимодействия с системой через Telegram.

#### Настройка бота

1. Получите токен бота у [@BotFather](https://t.me/BotFather) в Telegram
2. Отредактируйте файл `bot_config.yml`, указав токен и URL бэкенд-сервера:
   ```yaml
   bot:
     token: "YOUR_TELEGRAM_BOT_TOKEN" # Заменить на реальный токен
     backend_url: "http://localhost:8080" # URL бэкенд-сервера
     polling_interval_seconds: 5
     excel_threshold: 50
   ```

#### Сборка и запуск бота

```bash
# Сборка бота
go build -o bin/bot cmd/bot/main.go

# Запуск бота
./bin/bot
```

> Убедитесь, что бэкенд-сервер запущен и доступен по адресу, указанному в `backend_url`.

### Сервер

Приложение запускается как обычный консольный процесс. Для запуска в фоновом режиме используйте стандартные инструменты вашей ОС, такие как `systemd`, `supervisor` или Docker.

```bash
# Убедитесь, что config.yml настроен
./bin/server
```

Сервер корректно обрабатывает сигналы `SIGINT` и `SIGTERM` для graceful shutdown.

### Клиент

Клиент используется для отправки файлов на сервер.

```bash
# Обработать файл и получить task_id
./bin/client -file /path/to/chat.json

# Обработать по хешу (если результат уже есть в кэше сервера)
./bin/client -hash <sha256_of_file_content>
```

### Проверка работоспособности бота

1. **Проверка запуска**: Убедитесь, что бот успешно запустился и подключился к Telegram API - в логах должно быть сообщение `"Authorized on account" username="your_bot_username"`

2. **Тестирование команды `/start`**: Отправьте команду `/start` вашему боту в Telegram - бот должен ответить приветственным сообщением

3. **Тестирование обработки файлов**:
   - Подготовьте JSON-файл экспорта чата Telegram
   - Отправьте его боту
   - Бот должен ответить: `"✅ Файл получен и поставлен в очередь на обработку. Ожидайте результата."`
   - После обработки должен прийти результат (в виде текста или Excel-файла)

## Документация по API

Спецификацию OpenAPI для серверного API см. в файле [`api_contracts.yaml`](api_contracts.yaml).

Ключевые эндпоинты:
*   `POST /api/v1/process`: Загрузка файла для обработки.
*   `POST /api/v1/process-by-hash`: Запрос на обработку по хешу файла (использует кеш).
*   `GET /api/v1/tasks/{taskID}`: Получение статуса задачи.
*   `GET /api/v1/tasks/{taskID}/result`: Получение результата обработки с пагинацией.

## Разработка

*   Запуск тестов: `go test ./...`
*   Запуск линтера: `golangci-lint run`
